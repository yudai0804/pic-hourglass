LIST P=PIC16F1827
#include<p16f1827.inc>

LEDH EQU 0x20
LEDL EQU 0x21
SELECT_CNT EQU 0x22

CNT0 EQU 0x30
CNT1 EQU 0x31

BUZZER_CNT1 EQU 0x40

STATE_CNT1 EQU 0x51
STATE_CNT2 EQU 0x52
STATE_CNT3 EQU 0x53

TIMER_CNT0 EQU 0x70
TIMER_CNT1 EQU 0x71
TIMER_CNT2 EQU 0x72

STATE_CNT1_DEFAULT EQU D'10'
STATE_CNT2_DEFAULT EQU D'20'

STATE_CNT1_BUZZER_LED EQU D'80'

BUZZER EQU D'1'
 
START_SW EQU D'4'
RESET_SW EQU D'5'

__CONFIG    _CONFIG1, _FOSC_INTOSC & _WDTE_OFF & _PWRTE_ON & _MCLRE_OFF & _CP_OFF & _CPD_OFF & _BOREN_OFF & _CLKOUTEN_OFF & _IESO_OFF & _FCMEN_OFF
__CONFIG    _CONFIG2, _WRT_OFF & _PLLEN_OFF & _STVREN_OFF & _BORV_LO & _LVP_OFF

ORG 0x0000
    CLRF PORTA
    CLRF PORTB
    BSF BSR, BSR0
    ; バンク1
    ; クロックを4MHzに設定
    MOVLW B'01101000'
    MOVWF OSCCON
    BSF BSR, BSR1
    ; バンク3
    ; ディジタル入力を受け入れるようにする
    CLRF ANSELB
    ; バンク1
    BSF BSR, BSR0
    BCF BSR, BSR1
    MOVLW 0x00
    MOVWF TRISA
    MOVLW 0x30
    MOVWF TRISB
    ; バンク0
    BCF BSR, BSR0
    CLRF PORTA
    CLRF PORTB
    GOTO LOOP

SELECT_LED_DATA
    ; 1min, 2min
    DT 0x00,0x10,0x00,0x30
    ; 3min, 4min
    DT 0x00,0x70,0x00,0xf0
    ; 5min, 6min
    DT 0x01,0xf0,0x03,0xf0
    ; 7min, 8min
    DT 0x07,0xf0,0x0f,0xf0
    ; 9min, 10min
    DT 0x1f,0xf0,0x3f,0xf0
    ; 11min, 12min
    DT 0x7f,0xf0,0xff,0xf0

STATE_DATA
    ; 0, dummy
    DT 0x03,0xf0,0x00,0x00
    ; 1-ON, 1-OFF
    DT 0x03,0xf0,0x03,0xe0
    ; 2-ON, 2-OFF
    DT 0x07,0xe0,0x03,0xe0
    ; 3-ON, 3-OFF
    DT 0x0b,0xe0,0x03,0xe0
    ; 4-ON, 4-OFF
    DT 0x23,0xe0,0x03,0xe0
    ; 5-ON, 5-OFF
    DT 0x23,0xe0,0x23,0xc0
    ; 6-ON, 6-OFF
    DT 0x27,0xc0,0x23,0xc0
    ; 7-ON, 7-OFF
    DT 0x2b,0xc0,0x23,0xc0
    ; 8-ON, 8-OFF
    DT 0x63,0xc0,0x23,0xc0
    ; 9-ON, 9-OFF
    DT 0x63,0xc0,0x63,0x80
    ; 10-ON, 10-OFF
    DT 0x67,0x80,0x63,0x80
    ; 11-ON, 11-OFF
    DT 0x73,0x80,0x63,0x80
    ; 12-ON, 12-OFF
    DT 0xe3,0x80,0x63,0x80
    ; 13-ON, 13-OFF
    DT 0xe3,0x80,0xe3,0x00
    ; 14-ON, 14-OFF
    DT 0xe7,0x00,0xe3,0x00
    ; 15-ON, 15-OFF
    DT 0xeb,0x00,0xe3,0x00
    ; 16-ON, 16-OFF
    DT 0xeb,0x00,0xea,0x00
    ; 17-ON, 17-OFF
    DT 0xee,0x00,0xea,0x00
    ; 18-ON, 18-OFF
    DT 0xfa,0x00,0xea,0x00
    ; 19-ON, 19-OFF
    DT 0xfa,0x00,0xf8,0x00
    ; 20-ON, 20-OFF
    DT 0xfc,0x00,0cf8,0x00
STATE21_DATA
    ; 21, dummy
    DT 0xfc,0x00,0x00,0x00
    ; 22, dummy
    DT 0x00,0x00,0x00,0x00

LOOP
    MOVLW 0x01
    MOVWF SELECT_CNT
    MOVLW HIGH SELECT_LED_DATA
    MOVWF FSR0H
    MOVLW LOW SELECT_LED_DATA
    MOVWF FSR0L
    BTFSS PORTB, RESET_SW
    GOTO LOOP_L1
    CALL LEDBIT_FSR
    GOTO LOOP
LOOP_L1
    BTFSC PORTB, START_SW
    GOTO STATE
    CALL LEDBIT_FSR
    BTFSS PORTB, RESET_SW
    GOTO LOOP_L1
    CALL SELECT_BUZZER
    MOVF SELECT_CNT, W
    SUBLW D'12'
    BTFSC STATUS, Z
    GOTO LOOP
    INCF SELECT_CNT
    ADDFSR FSR0, 0x02
LOOP_L2
    CALL LEDBIT_FSR
    BTFSC PORTB, RESET_SW
    GOTO LOOP_L2
    GOTO LOOP_L1

STATE
    MOVLW STATE_CNT1_BUZZER_LED
    MOVWF STATE_CNT1
    MOVLW HIGH STATE_DATA
    MOVWF FSR0H
    MOVLW LOW STATE_DATA
    MOVWF FSR0L
STATE0
    ; 作業中にうるさいのでコメントアウト
    ; CALL SELECT_BUZZER
    CALL LEDBIT_FSR
    DECFSZ STATE_CNT1
    GOTO STATE0
    ADDFSR FSR0, 0x04
STATE1
    MOVLW STATE_CNT1_DEFAULT
    MOVWF STATE_CNT1
STATE1_L1
    MOVLW STATE_CNT2_DEFAULT
    MOVWF STATE_CNT2
    DECFSZ STATE_CNT1
    GOTO STATE1_TASK
    GOTO STATE1_INC
STATE1_TASK
    DECFSZ STATE_CNT2
    GOTO STATE1_ON
    MOVLW STATE_CNT2_DEFAULT
    MOVWF STATE_CNT2
STATE1_TASK_L1
    DECFSZ STATE_CNT2
    GOTO STATE1_OFF
    GOTO STATE1_L1

STATE1_ON
    BTFSC PORTB, RESET_SW
    GOTO LOOP
    MOVIW 0[FSR0]
    MOVWF LEDH
    MOVIW 1[FSR0]
    MOVWF LEDL
    CALL LEDBIT
    GOTO STATE1_TASK

STATE1_OFF
    BTFSC PORTB, RESET_SW
    GOTO LOOP
    MOVIW 2[FSR0]
    MOVWF LEDH
    MOVIW 3[FSR0]
    MOVWF LEDL
    CALL LEDBIT
    GOTO STATE1_TASK_L1

STATE1_INC
    ADDFSR FSR0, 0x04
    MOVF FSR0H, W
    SUBLW HIGH STATE21_DATA
    BTFSS STATUS, Z
    GOTO STATE1
    MOVF FSR0L, W
    SUBLW LOW STATE21_DATA
    BTFSS STATUS, Z
    GOTO STATE1
    MOVLW STATE_CNT1_BUZZER_LED
    MOVWF STATE_CNT1
    GOTO STATE21

STATE21
    ; 作業中にうるさいのでコメントアウト
    ; CALL SELECT_BUZZER
    CALL LEDBIT_FSR
    DECFSZ STATE_CNT1
    GOTO STATE21
    MOVLW STATE_CNT1_BUZZER_LED
    MOVWF STATE_CNT1
    ADDFSR FSR0, 0x04
STATE22
    CALL LEDBIT_FSR
    DECFSZ STATE_CNT1
    GOTO STATE22
    GOTO LOOP

LEDBIT_FSR
    MOVIW 0[FSR0]
    MOVWF LEDH
    MOVIW 1[FSR0]
    MOVWF LEDL
    CALL LEDBIT
    RETURN
    
LEDBIT
    MOVLW D'9'
    MOVWF CNT0
LED_L1
    DECFSZ CNT0
    GOTO LED_L3
    MOVLW D'5'
    MOVWF CNT0
LED_L2
    DECFSZ CNT0
    GOTO LED_L4
    RETURN

LED_L3
    MOVF CNT0, W
    RLF LEDH, F
    BTFSS STATUS, C
    MOVLW D'0'
    CALL LED_L3_CALC_GOTO
    GOTO LED_L1
LED_L3_CALC_GOTO
    BRW
    GOTO LEDCLR
    GOTO LED5
    GOTO LED6
    GOTO LED7
    GOTO LED8
    GOTO LED9
    GOTO LED10
    GOTO LED11
    GOTO LED12

LED_L4
    MOVF CNT0, W
    RLF LEDL, F
    BTFSS STATUS, C
    MOVLW D'0'
    CALL LED_L4_CALC_GOTO
    GOTO LED_L2
LED_L4_CALC_GOTO
    BRW
    GOTO LEDCLR
    GOTO LED1
    GOTO LED2
    GOTO LED3
    GOTO LED4

SELECT_BUZZER
    MOVLW D'8'
    MOVWF CNT1
_SELECT_BUZZER
    MOVIW 0[FSR0]
    MOVWF LEDH
    MOVIW 1[FSR0]
    MOVWF LEDL
    CALL SELECT_BUZZER_LEDBIT
    DECFSZ CNT1
    GOTO _SELECT_BUZZER
    RETURN
    
SELECT_BUZZER_LEDBIT
    MOVLW D'9'
    MOVWF CNT0
SELECT_BUZZER_L1
    DECFSZ CNT0
    GOTO SELECT_BUZZER_L3
    MOVLW D'5'
    MOVWF CNT0
SELECT_BUZZER_L2
    DECFSZ CNT0
    GOTO SELECT_BUZZER_L4
    RETURN

SELECT_BUZZER_L3
    BTFSS CNT0, 0
    GOTO SELECT_BUZZER_L3_ON
    GOTO SELECT_BUZZER_L3_OFF
_SELECT_BUZZER_L3
    MOVF CNT0, W
    RLF LEDH, F
    BTFSS STATUS, C
    MOVLW D'0'
    CALL SELECT_BUZZER_L3_CALC_GOTO
    GOTO SELECT_BUZZER_L1
SELECT_BUZZER_L3_CALC_GOTO
    BRW
    GOTO LEDCLR
    GOTO LED5
    GOTO LED6
    GOTO LED7
    GOTO LED8
    GOTO LED9
    GOTO LED10
    GOTO LED11
    GOTO LED12

SELECT_BUZZER_L3_ON
    BSF PORTA, BUZZER
    GOTO _SELECT_BUZZER_L3
SELECT_BUZZER_L3_OFF
    BCF PORTA, BUZZER
    GOTO _SELECT_BUZZER_L3

SELECT_BUZZER_L4
    BTFSS CNT0, 0
    GOTO SELECT_BUZZER_L4_ON
    GOTO SELECT_BUZZER_L4_OFF
_SELECT_BUZZER_L4
    MOVF CNT0, W
    RLF LEDL, F
    BTFSS STATUS, C
    MOVLW D'0'
    CALL SELECT_BUZZER_L4_CALC_GOTO
    GOTO SELECT_BUZZER_L2
SELECT_BUZZER_L4_CALC_GOTO
    BRW
    GOTO LEDCLR
    GOTO LED1
    GOTO LED2
    GOTO LED3
    GOTO LED4

SELECT_BUZZER_L4_ON
    BSF PORTA, BUZZER
    GOTO _SELECT_BUZZER_L4
SELECT_BUZZER_L4_OFF
    BCF PORTA, BUZZER
    GOTO _SELECT_BUZZER_L4

LEDCLR
    MOVLW B'11100011'
    ANDWF PORTA, F
    MOVF PORTB, W
    ANDLW B'11110000'
    ADDLW 0x00
    MOVWF PORTB
    MOVLW 0x00
    ADDWF PORTA, F
    CALL TIMER_LED
    RETURN

LED1
    MOVLW B'11100011'
    ANDWF PORTA, F
    MOVF PORTB, W
    ANDLW B'11110000'
    ADDLW B'00000111'
    MOVWF PORTB
    MOVLW B'00000100'
    ADDWF PORTA, F
    CALL TIMER_LED
    RETURN
LED2
    MOVLW B'11100011'
    ANDWF PORTA, F
    MOVF PORTB, W
    ANDLW B'11110000'
    ADDLW B'00001011'
    MOVWF PORTB
    MOVLW B'00000100'
    ADDWF PORTA, F
    CALL TIMER_LED
    RETURN
LED3
    MOVLW B'11100011'
    ANDWF PORTA, F
    MOVF PORTB, W
    ANDLW B'11110000'
    ADDLW B'00001101'
    MOVWF PORTB
    MOVLW B'00000100'
    ADDWF PORTA, F
    CALL TIMER_LED
    RETURN
LED4
    MOVLW B'11100011'
    ANDWF PORTA, F
    MOVF PORTB, W
    ANDLW B'11110000'
    ADDLW B'00000111'
    MOVWF PORTB
    MOVLW B'00001000'
    ADDWF PORTA, F
    CALL TIMER_LED
    RETURN
LED5
    MOVLW B'11100011'
    ANDWF PORTA, F
    MOVF PORTB, W
    ANDLW B'11110000'
    ADDLW B'00001011'
    MOVWF PORTB
    MOVLW B'00001000'
    ADDWF PORTA, F
    CALL TIMER_LED
    RETURN
LED6
    MOVLW B'11100011'
    ANDWF PORTA, F
    MOVF PORTB, W
    ANDLW B'11110000'
    ADDLW B'00000111'
    MOVWF PORTB
    MOVLW B'00010000'
    ADDWF PORTA, F
    CALL TIMER_LED
    RETURN
LED7
    MOVLW B'11100011'
    ANDWF PORTA, F
    MOVF PORTB, W
    ANDLW B'11110000'
    ADDLW B'00001110'
    MOVWF PORTB
    MOVLW B'00000100'
    ADDWF PORTA, F
    CALL TIMER_LED
    RETURN
LED8
    MOVLW B'11100011'
    ANDWF PORTA, F
    MOVF PORTB, W
    ANDLW B'11110000'
    ADDLW B'00001101'
    MOVWF PORTB
    MOVLW B'00001000'
    ADDWF PORTA, F
    CALL TIMER_LED
    RETURN
LED9
    MOVLW B'11100011'
    ANDWF PORTA, F
    MOVF PORTB, W
    ANDLW B'11110000'
    ADDLW B'00001110'
    MOVWF PORTB
    MOVLW B'00001000'
    ADDWF PORTA, F
    CALL TIMER_LED
    RETURN
LED10
    MOVLW B'11100011'
    ANDWF PORTA, F
    MOVF PORTB, W
    ANDLW B'11110000'
    ADDLW B'00001011'
    MOVWF PORTB
    MOVLW B'00010000'
    ADDWF PORTA, F
    CALL TIMER_LED
    RETURN
LED11
    MOVLW B'11100011'
    ANDWF PORTA, F
    MOVF PORTB, W
    ANDLW B'11110000'
    ADDLW B'00001101'
    MOVWF PORTB
    MOVLW B'00010000'
    ADDWF PORTA, F
    CALL TIMER_LED
    RETURN
LED12
    MOVLW B'11100011'
    ANDWF PORTA, F
    MOVF PORTB, W
    ANDLW B'11110000'
    ADDLW B'00001110'
    MOVWF PORTB
    MOVLW B'00010000'
    ADDWF PORTA, F
    CALL TIMER_LED
    RETURN

;1ms
TIMER_LED
    MOVLW D'199'
    MOVWF TIMER_CNT1
TIMER_LED_L1
    NOP
    NOP
    DECFSZ TIMER_CNT1,F
    GOTO TIMER_LED_L1
    RETURN

TIMER_1000MS
    MOVLW D'173'
    MOVWF TIMER_CNT1
TIMER_1000MS_L1
    MOVLW D'191'
    MOVWF TIMER_CNT2
TIMER_1000MS_L2
    DECFSZ TIMER_CNT2,F
    GOTO TIMER_1000MS_L2
    NOP
    DECFSZ TIMER_CNT1,F
    GOTO TIMER_1000MS_L1
    NOP
    RETURN

end